<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Printing...</title>
  <link rel="stylesheet" href="theme.css">
  <link rel="stylesheet" href="Kiosk Css/printing.css">
  <style>
    body {
      background: #161d27;
      color: #fff;
      font-family: 'Lilita One', 'Arial', sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
      margin: 0;
    }
    .preview-user {
      background: #232c3b;
      color: #ffbe3b;
      border-radius: 10px;
      padding: 10px 22px;
      font-size: 1.13rem;
      font-weight: bold;
      margin-bottom: 18px;
      display: flex;
      align-items: center;
      gap: 8px;
      letter-spacing: 1px;
      box-shadow: 0 2px 16px #0002;
    }
    .preview-user .user-icon {
      font-size: 1.22em;
      margin-right: 7px;
    }
    .loader {
      border: 8px solid #222b3a;
      border-top: 8px solid #ffbe3b;
      border-radius: 50%;
      width: 64px;
      height: 64px;
      animation: spin 1s linear infinite;
      margin-bottom: 24px;
      display: none;
    }
    @keyframes spin {
      0% { transform: rotate(0deg);}
      100% { transform: rotate(360deg);}
    }
    .printing-text {
      font-size: 2rem;
      letter-spacing: 1px;
      color: #ffbe3b;
      margin-bottom: 32px;
      display: none;
    }
    .receipt-preview {
      background: #fff;
      color: #222b3a;
      padding: 24px 32px;
      border-radius: 12px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.12);
      font-family: 'IM FELL GreatPrimer', serif;
      width: 320px;
      margin-bottom: 40px;
      display: none;
    }
    .receipt-preview h2 {
      text-align: center;
      font-size: 1.5rem;
      margin-bottom: 8px;
      font-family: 'Lilita One', sans-serif;
      color: #161d27;
      letter-spacing: 1px;
    }
    .receipt-line {
      font-size: 1.1rem;
      margin: 8px 0;
      display: flex;
      justify-content: space-between;
      border-bottom: 1px dashed #ddd;
      padding-bottom: 3px;
    }
    .receipt-label {
      font-weight: bold;
      color: #3a465e;
    }
    .receipt-value {
      text-align: right;
      max-width: 140px;
      overflow-wrap: break-word;
      word-break: break-word;
    }
    .receipt-thankyou {
      text-align: center;
      margin-top: 18px;
      font-size: 1rem;
      color: #666;
      letter-spacing: 1px;
    }
    #printBtn {
      padding: 10px 24px;
      font-size: 1rem;
      border-radius: 6px;
      border: none;
      background: #ffbe3b;
      color: #222b3a;
      font-weight: bold;
      cursor: pointer;
      transition: background 0.2s;
      margin-bottom: 14px;
      margin-top: 10px;
    }
    #printBtn:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
  </style>
</head>
<body>
  <div class="preview-user" id="previewUser" style="display:none;">
    <span class="user-icon">üë§</span>
    <span id="previewUserName"></span>
  </div>
  <div class="receipt-preview" id="receiptPreview" style="display:none;"></div>
  <button id="printBtn" disabled>Print</button>
  <div class="loader" id="loader"></div>
  <div class="printing-text" id="printingText">Printing...</div>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <script>
    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyDZsj-cL_T_BuLtAz5bkqsw-edZXnumwe0",
      authDomain: "iot-web-58054.firebaseapp.com",
      databaseURL: "https://iot-web-58054-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "iot-web-58054",
      storageBucket: "iot-web-58054.appspot.com",
      messagingSenderId: "949884902967",
      appId: "1:949884902967:web:6e7f78c7cd0fa1484629b2",
      measurementId: "G-5C79490N66"
    };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);

    // For your single-user session, get the registered UID
    const uid = localStorage.getItem("registeredUID");
    const previewUser = document.getElementById("previewUser");
    const previewUserName = document.getElementById("previewUserName");
    const receiptPreview = document.getElementById("receiptPreview");
    const printBtn = document.getElementById("printBtn");
    const loader = document.getElementById("loader");
    const printingText = document.getElementById("printingText");
    let selectedUser = null;

    function showPreview(user, uid) {
      const displayName = user.name || user.fullName || user.username || user.businessName || uid;
      previewUserName.textContent = displayName;
      previewUser.style.display = "flex";
      receiptPreview.innerHTML = `
        <h2>ScaleUp Kiosk Receipt</h2>
        <div class="receipt-line"><span class="receipt-label">Business:</span> <span class="receipt-value">${user.businessName || "(none)"}</span></div>
        <div class="receipt-line"><span class="receipt-label">Product:</span> <span class="receipt-value">${user.product || "(none)"}</span></div>
        <div class="receipt-line"><span class="receipt-label">Tagline:</span> <span class="receipt-value">${user.tagline || "(none)"}</span></div>
      `;
      receiptPreview.style.display = "block";
      printBtn.disabled = false;
    }

    function showNoUser() {
      previewUser.style.display = "none";
      receiptPreview.innerHTML = `<h2>‚ö†Ô∏è No Registered User Found</h2>
        <div class="receipt-line"><span class="receipt-label">Please register first.</span></div>`;
      receiptPreview.style.display = "block";
      printBtn.disabled = true;
    }

    function formatForPrinter(user, uid) {
      let lines = [
        "==============================",
        "        ScaleUp Kiosk         ",
        "==============================",
        `Name:         ${user.name || user.fullName || user.username || user.businessName || uid}`,
      ];
      if (user.businessName) lines.push(`Business Name: ${user.businessName}`);
      if (user.product) lines.push(`Product:      ${user.product}`);
      if (user.tagline) lines.push(`Tagline:      ${user.tagline}`);
      lines.push("", "   Thank You for Using ScaleUp!", "==============================");
      return lines.join('\n');
    }

    if (uid) {
      firebase.database().ref("users/" + uid).once("value").then(snapshot => {
        const user = snapshot.val();
        if (!user) return showNoUser();
        selectedUser = user;
        showPreview(user, uid);
      }).catch(showNoUser);
    } else {
      showNoUser();
    }

    printBtn.addEventListener("click", function() {
  if (!selectedUser) return;
  loader.style.display = "block";
  printingText.style.display = "block";
  printBtn.style.display = "none";
  receiptPreview.style.display = "block";

  // Send print request to Firebase
  const deviceName = "POS58DE487";
  const requestRef = firebase.database().ref('print_requests').push();
  requestRef.set({
    deviceName: deviceName,
    text: formatForPrinter(selectedUser, uid),
    timestamp: Date.now()
  }).finally(() => {
    // Reset all local storage and session storage before redirect
    localStorage.clear();
    sessionStorage.clear();
    setTimeout(function() {
      window.location.href = "login.html";
    }, 8000);
  });
});
  </script>
</body>
</html>